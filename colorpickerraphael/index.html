<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Color Picker</title>
        <style type="text/css" media="screen">
            body {
                background: #333;
                margin: 0;
            }
            span {
                display: block; /* one message per line */
            }
        </style>
        <script src="js/raphael.js" type="text/javascript"></script>
        <script src="js/colorpicker.js" type="text/javascript"></script>
        <script src="js/colorwheel.js" type="text/javascript"></script>
        <script src="js/colors.min.js" type="text/javascript"></script>
        <script src="js/mqttws31.js" type="text/javascript"></script>
        <script src="js/jquery.min.js" type="text/javascript"></script>
        <script type="text/javascript">
            
            /**
             * Function to map 0-360 to 0-255
             * https://github.com/FastLED/FastLED/issues/147
             */
            Number.prototype.map = function ( in_min , in_max , out_min , out_max ) {
                return Math.round(( this - in_min ) * ( out_max - out_min ) / ( in_max - in_min ) + out_min);
            }
            
            Raphael(function () {
                var reg = /^#(.)\1(.)\2(.)\3$/,
                // this is where colorpicker created
                cp = Raphael.colorpicker(0, 0, 200, "#eee", "picker");
                clr = Raphael.color("#eee");
                
                // assigning onchange event handler
                cp.onchange = function (clr) {
                    var hue = Colors.hex2hsv(clr).H;
//                    console.log(hue);
                    console.log(hue.map(0, 360, 0, 255));
                    publish(hue.map(0, 360, 0, 255),topic+'bitmap', 2);
                };
            });
            
            host = 'shineupon.me';
            port = 9001;
            topic = '/hackaveiro/';
            
            //Using the HiveMQ public Broker, with a random client Id
            var client = new Messaging.Client(host, port, "myclientid_" + parseInt(Math.random() * 100, 10));

            //Gets  called if the websocket/mqtt connection gets disconnected for any reason
            client.onConnectionLost = function (responseObject) {
                //Depending on your scenario you could implement a reconnect logic here
                $("#messages").append("connection lost: " + responseObject.errorMessage);
            };

            //Gets called whenever you receive a message for your subscriptions
            client.onMessageArrived = function (message) {
                //Do something with the push message you received
                $('#messages').append('<span>Topic: ' + message.destinationName + '  | ' + message.payloadString + '</span>');
            };

            //Connect Options
            var options = {
                timeout: 3,
                //Gets Called if the connection has sucessfully been established
                onSuccess: function () {
                    $("#messages").append("Connected");
                    client.subscribe(topic+'#', {qos: 2});
                },
                //Gets Called if the connection could not be established
                onFailure: function (message) {
                    $("#messages").append("Connection failed: " + message.errorMessage);
                }
            };

            //Creates a new Messaging.Message Object and sends it to the HiveMQ MQTT Broker
            var publish = function (payload, topic, qos) {
                //Send your message (also possible to serialize it as JSON or protobuf or just use a string, no limitations)
                var message = new Messaging.Message(""+payload);
                message.destinationName = topic;
                message.qos = qos;
                client.send(message);
                
            }
            
            $( document ).ready(function() {
                client.connect(options);
//                $("#color").change(function(){
//                    publish(topic+'bitmap', 2);
//                });
            });
        </script>
    </head>
    <body>
        <div id="picker"></div>
        <div id="messages"></div>
    </body>
</html>
